name: Tests

on:
  push:
    branches: [ main, feature/** ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      neo4j:
        image: neo4j:5
        ports:
          - 7474:7474
          - 7687:7687
        env:
          NEO4J_AUTH: neo4j/password

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Wait for Neo4j to be ready
        run: |
          python -c "
          import time
          from neo4j import GraphDatabase
          for i in range(30):
              try:
                  driver = GraphDatabase.driver('bolt://localhost:7687', auth=('neo4j', 'password'))
                  driver.verify_connectivity()
                  driver.close()
                  print('Neo4j is ready!')
                  break
              except Exception as e:
                  if i == 29:
                      raise
                  time.sleep(2)
          "

      - name: Seed test data
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: password
          NEO4J_DATABASE: neo4j
        run: |
          python scripts/seed_data.py

      - name: Run tests with coverage
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: password
          NEO4J_DATABASE: neo4j
        run: |
          pytest tests/test_app.py tests/test_schedule_optimizer.py tests/test_advanced_queries.py tests/test_degree_planner.py tests/test_graduation_paths.py tests/unit/ --cov=backend --cov-report=term --cov-fail-under=60


